version: "3.0"

services:

  server:
    build: build/server
    volumes:
      - ./src/server:/var/www/html
      - ./src/vendor:/var/www/vendor
    command: [php, /var/www/html/server.php]
    ports:
      - 9501:9501
    depends_on:
      - redis

  redis:
    image: redis
    volumes:
      - ./data/redis:/data

  test:
    build: build/test
    volumes:
      - ./src/vendor:/var/php/test/vendor
      - ./tests:/var/php/test/tests
    working_dir: /var/php
    command: [
      php, vendor/bin/phpunit, test/tests,
      --bootstrap, test/tests/bootstrap.php #, --testdox
      ]

  client:
    build: build/client
    volumes: 
      - ./src/client:/var/www
    restart: always
    command: [php, -S, 0.0.0.0:8000]
    working_dir: /var/www
    ports:
      - 9502:8000

  example_client:
    image: php:8.1
    volumes:
      - ./demo:/var/www
    working_dir: /var/www
    command: [php, -S, 0.0.0.0:8000, index.php]
    ports:
      - 12345:8000
    depends_on:
      - server
